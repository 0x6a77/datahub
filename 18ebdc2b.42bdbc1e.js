(window.webpackJsonp=window.webpackJsonp||[]).push([[8],{165:function(e,n,t){"use strict";t.d(n,"a",(function(){return p})),t.d(n,"b",(function(){return h}));var a=t(0),r=t.n(a);function i(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function o(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function s(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?o(Object(t),!0).forEach((function(n){i(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):o(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function c(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)t=i[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)t=i[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var d=r.a.createContext({}),l=function(e){var n=r.a.useContext(d),t=n;return e&&(t="function"==typeof e?e(n):s(s({},n),e)),t},p=function(e){var n=l(e.components);return r.a.createElement(d.Provider,{value:n},e.children)},u={inlineCode:"code",wrapper:function(e){var n=e.children;return r.a.createElement(r.a.Fragment,{},n)}},b=r.a.forwardRef((function(e,n){var t=e.components,a=e.mdxType,i=e.originalType,o=e.parentName,d=c(e,["components","mdxType","originalType","parentName"]),p=l(t),b=a,h=p["".concat(o,".").concat(b)]||p[b]||u[b]||i;return t?r.a.createElement(h,s(s({ref:n},d),{},{components:t})):r.a.createElement(h,s({ref:n},d))}));function h(e,n){var t=arguments,a=n&&n.mdxType;if("string"==typeof e||a){var i=t.length,o=new Array(i);o[0]=b;var s={};for(var c in n)hasOwnProperty.call(n,c)&&(s[c]=n[c]);s.originalType=e,s.mdxType="string"==typeof e?e:a,o[1]=s;for(var d=2;d<i;d++)o[d]=t[d];return r.a.createElement.apply(null,o)}return r.a.createElement.apply(null,t)}b.displayName="MDXCreateElement"},72:function(e,n,t){"use strict";t.r(n),t.d(n,"frontMatter",(function(){return o})),t.d(n,"metadata",(function(){return s})),t.d(n,"rightToc",(function(){return c})),t.d(n,"default",(function(){return l}));var a=t(3),r=t(7),i=(t(0),t(165)),o={title:"Onboarding to GMA Search - searching over a new field",hide_title:!0,slug:"/how/search-over-new-field",custom_edit_url:"https://github.com/linkedin/datahub/blob/master/docs/how/search-over-new-field.md"},s={unversionedId:"docs/how/search-over-new-field",id:"docs/how/search-over-new-field",isDocsHomePage:!1,title:"Onboarding to GMA Search - searching over a new field",description:"Onboarding to GMA Search - searching over a new field",source:"@site/genDocs/docs/how/search-over-new-field.md",slug:"/how/search-over-new-field",permalink:"/docs/how/search-over-new-field",editUrl:"https://github.com/linkedin/datahub/blob/master/docs/how/search-over-new-field.md",version:"current",sidebar:"overviewSidebar",previous:{title:"How to onboard to GMA search?",permalink:"/docs/how/search-onboarding"},next:{title:"OIDC Authentication in React",permalink:"/docs/how/configure-oidc-react"}},c=[{value:"Steps",id:"steps",children:[{value:"1: Add field to aspect (skip this step if the field already exists in an aspect)",id:"1-add-field-to-aspect-skip-this-step-if-the-field-already-exists-in-an-aspect",children:[]},{value:"2: Add field to search document model",id:"2-add-field-to-search-document-model",children:[]},{value:"3: Modify the mapping of search index",id:"3-modify-the-mapping-of-search-index",children:[]},{value:"4: Modify index config, so that the new mapping is picked up next time",id:"4-modify-index-config-so-that-the-new-mapping-is-picked-up-next-time",children:[]},{value:"5: Update the index builder logic",id:"5-update-the-index-builder-logic",children:[]},{value:"6: Update search query template, to start searching over the new field",id:"6-update-search-query-template-to-start-searching-over-the-new-field",children:[]},{value:"7: (<em>Optional</em>) For a field that is a facet, modify the search config.",id:"7-optional-for-a-field-that-is-a-facet-modify-the-search-config",children:[]},{value:"8: Test your changes",id:"8-test-your-changes",children:[]}]},{value:"Appendix: MidTier and UI changes",id:"appendix-midtier-and-ui-changes",children:[{value:"1: Check if facets are enabled for the entity (optional)",id:"1-check-if-facets-are-enabled-for-the-entity-optional",children:[]},{value:"2: Add fields to facets in MidTier if desired (optional)",id:"2-add-fields-to-facets-in-midtier-if-desired-optional",children:[]},{value:"3: Add field in the Person entity",id:"3-add-field-in-the-person-entity",children:[]},{value:"4: Add fields in the Person configuration json",id:"4-add-fields-in-the-person-configuration-json",children:[]}]}],d={rightToc:c};function l(e){var n=e.components,t=Object(r.a)(e,["components"]);return Object(i.b)("wrapper",Object(a.a)({},d,t,{components:n,mdxType:"MDXLayout"}),Object(i.b)("h1",{id:"onboarding-to-gma-search---searching-over-a-new-field"},"Onboarding to GMA Search - searching over a new field"),Object(i.b)("p",null,"If you need to onboard a new entity to search, refer to ",Object(i.b)("a",{parentName:"p",href:"/docs/how/search-onboarding"},"How to onboard to GMA Search"),"."),Object(i.b)("p",null,"For this exercise, we'll add a new field to an existing aspect of corp users and search over this field. Your use case might require searching over an existing field of an aspect or create a brand new aspect and search over it's field(s). For such use cases, similar steps should be followed."),Object(i.b)("p",null,"This document will also guide you on how to leverage an existing field for faceted search i.e. use the field in aggregations, sorting or in a script."),Object(i.b)("h2",{id:"steps"},"Steps"),Object(i.b)("h3",{id:"1-add-field-to-aspect-skip-this-step-if-the-field-already-exists-in-an-aspect"},"1: Add field to aspect (skip this step if the field already exists in an aspect)"),Object(i.b)("p",null,"For this example, we will add new field ",Object(i.b)("inlineCode",{parentName:"p"},"courses")," to ",Object(i.b)("a",{parentName:"p",href:"https://github.com/linkedin/datahub/blob/master/metadata-models/src/main/pegasus/com/linkedin/identity/CorpUserEditableInfo.pdl"},"CorpUserEditableInfo")," which is an aspect of corp user entity."),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre"},'namespace com.linkedin.identity\n\n/**\n * Linkedin corp user information that can be edited from UI\n */\n@Aspect.EntityUrns = [ "com.linkedin.common.CorpuserUrn" ]\nrecord CorpUserEditableInfo {\n\n  ...\n\n  /**\n   * Courses that the user has taken e.g. AI200: Introduction to Artificial Intelligence\n   */\n  courses: array[string] = [ ]\n\n}\n')),Object(i.b)("h3",{id:"2-add-field-to-search-document-model"},"2: Add field to search document model"),Object(i.b)("p",null,"For this example, we will add field ",Object(i.b)("inlineCode",{parentName:"p"},"courses")," to ",Object(i.b)("a",{parentName:"p",href:"https://github.com/linkedin/datahub/blob/master/metadata-models/src/main/pegasus/com/linkedin/metadata/search/CorpUserInfoDocument.pdl"},"CorpUserInfoDocument.pdl")," which is the search document model for corp user entity."),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre"},"namespace com.linkedin.metadata.search\n\n/**\n * Data model for CorpUserInfo entity search\n */\nrecord CorpUserInfoDocument includes BaseDocument {\n\n  ...\n\n  /**\n   * Courses that the user has taken e.g. AI200: Introduction to Artificial Intelligence\n   */\n  courses: optional array[string]\n\n}\n")),Object(i.b)("h3",{id:"3-modify-the-mapping-of-search-index"},"3: Modify the mapping of search index"),Object(i.b)("p",null,"Now, we will modify the mapping of corp user search index. Use the following Elasticsearch command to add new field to an existing index."),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-sh"},'curl http://localhost:9200/corpuserinfodocument/doc/_mapping? --data \'\n{\n  "properties": {\n    "courses": {\n      "type": "text"\n    }\n  }\n}\'\n')),Object(i.b)("p",null,"If this field needs to be a facet i.e. you want to enable sorting, aggregations on this field or use it in scripts, then your mapping may be different depending on the type of field. For ",Object(i.b)("strong",{parentName:"p"},"text")," fields you will need to enable ",Object(i.b)("em",{parentName:"p"},"fielddata")," (disabled by default), as shown below"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-json"},'curl http://localhost:9200/corpuserinfodocument/doc/_mapping? --data \'\n{\n  "properties": {\n    "courses": {\n      "type": "text",\n      "fielddata": true\n    }\n  }\n}\'\n')),Object(i.b)("p",null,"However ",Object(i.b)("em",{parentName:"p"},"fielddata")," enablement could consume significant heap space. If possible, use unanalyzed ",Object(i.b)("strong",{parentName:"p"},"keyword")," field as a facet. For the current example, you could either choose keyword type for the field ",Object(i.b)("em",{parentName:"p"},"courses")," or create a subfield of type keyword under ",Object(i.b)("em",{parentName:"p"},"courses")," and use the same for sorting, aggregations, etc (second approach described below)"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-shell"},'curl http://localhost:9200/corpuserinfodocument/doc/_mapping? --data \'\n{\n  "properties": {\n    "courses": {\n      "type": "text",\n      "fields": {\n        "subfield": {\n          "type": "keyword"\n        }\n      }\n    }\n  }\n}\'\n')),Object(i.b)("p",null,"More on this is explained in ",Object(i.b)("a",{parentName:"p",href:"https://www.elastic.co/guide/en/elasticsearch/reference/current/fielddata.html"},"ES guides"),"."),Object(i.b)("h3",{id:"4-modify-index-config-so-that-the-new-mapping-is-picked-up-next-time"},"4: Modify index config, so that the new mapping is picked up next time"),Object(i.b)("p",null,"If you want corp user search index to contain this new field ",Object(i.b)("inlineCode",{parentName:"p"},"courses")," next time docker containers are brought up, we need to add this field to ",Object(i.b)("a",{parentName:"p",href:"https://github.com/linkedin/datahub/blob/master/gms/impl/src/main/resources/index/corp-user/mappings.json"},"corpuser mappings"),"."),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre"},'{\n  "properties": {\n\n    ...\n\n    "courses": {\n      "type": "text"\n    }\n  }\n}\n')),Object(i.b)("p",null,"Choose your analyzer wisely. For this example, we store the field ",Object(i.b)("inlineCode",{parentName:"p"},"courses")," as an array of string and hence use ",Object(i.b)("inlineCode",{parentName:"p"},"text")," data type. Default analyzer is ",Object(i.b)("inlineCode",{parentName:"p"},"standard")," and it provides grammar based tokenization."),Object(i.b)("h3",{id:"5-update-the-index-builder-logic"},"5: Update the index builder logic"),Object(i.b)("p",null,"Index builder is where the logic to transform an aspect to search document model is defined. For this example, we will add the logic in ",Object(i.b)("a",{parentName:"p",href:"https://github.com/linkedin/datahub/blob/master/metadata-builders/src/main/java/com/linkedin/metadata/builders/search/CorpUserInfoIndexBuilder.java"},"CorpUserInfoIndexBuilder"),"."),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-java"},'package com.linkedin.metadata.builders.search;\n\n@Slf4j\npublic class CorpUserInfoIndexBuilder extends BaseIndexBuilder<CorpUserInfoDocument> {\n\n  public CorpUserInfoIndexBuilder() {\n    super(Collections.singletonList(CorpUserSnapshot.class), CorpUserInfoDocument.class);\n  }\n\n  ...\n\n  @Nonnull\n  private CorpUserInfoDocument getDocumentToUpdateFromAspect(@Nonnull CorpuserUrn urn,\n      @Nonnull CorpUserEditableInfo corpUserEditableInfo) {\n    final String aboutMe = corpUserEditableInfo.getAboutMe() == null ? "" : corpUserEditableInfo.getAboutMe();\n    return new CorpUserInfoDocument()\n        .setUrn(urn)\n        .setAboutMe(aboutMe)\n        .setTeams(corpUserEditableInfo.getTeams())\n        .setSkills(corpUserEditableInfo.getSkills())\n        .setCourses(corpUserEditableInfo.getCourses());\n  }\n\n  ...\n\n}\n\n')),Object(i.b)("h3",{id:"6-update-search-query-template-to-start-searching-over-the-new-field"},"6: Update search query template, to start searching over the new field"),Object(i.b)("p",null,"For this example, we will modify ",Object(i.b)("a",{parentName:"p",href:"https://github.com/linkedin/datahub/blob/master/gms/impl/src/main/resources/corpUserESSearchQueryTemplate.json"},"corpUserESSearchQueryTemplate.json")," to start searching over the field ",Object(i.b)("inlineCode",{parentName:"p"},"courses"),". Here is an example."),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-json"},'{\n  "function_score": {\n    "query": {\n      "query_string": {\n        "query": "$INPUT",\n        "fields": [\n          "fullName^4",\n          "ldap^2",\n          "managerLdap",\n          "skills",\n          "courses"\n          "teams",\n          "title"\n        ],\n        "default_operator": "and",\n        "analyzer": "standard"\n      }\n    },\n    "functions": [\n      {\n        "filter": {\n          "term": {\n            "active": true\n          }\n        },\n        "weight": 2\n      }\n    ],\n    "score_mode": "multiply"\n  }\n}\n')),Object(i.b)("p",null,"As you can see in the above query template, corp user search is performed across multiple fields, to which the field ",Object(i.b)("inlineCode",{parentName:"p"},"courses")," has been added."),Object(i.b)("h3",{id:"7-optional-for-a-field-that-is-a-facet-modify-the-search-config"},"7: (",Object(i.b)("em",{parentName:"h3"},"Optional"),") For a field that is a facet, modify the search config."),Object(i.b)("p",null,"We define the list of facets in search config. If your field needs to be a facet, add it to the set of facets defined in method ",Object(i.b)("em",{parentName:"p"},"getFacetFields"),". For this example, we will add the logic in ",Object(i.b)("a",{parentName:"p",href:"https://github.com/linkedin/datahub/blob/master/gms/impl/src/main/java/com/linkedin/metadata/configs/CorpUserSearchConfig.java"},"CorpUserSearchConfig"),"."),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-java"},'package com.linkedin.metadata.configs;\n\npublic class CorpUserSearchConfig extends BaseSearchConfig<CorpUserInfoDocument> {\n  @Override\n  @Nonnull\n  public Set<String> getFacetFields() {\n    return Collections.unmodifiableSet(new HashSet<>(Arrays.asList("courses"));\n  }\n\n  ...\n}\n')),Object(i.b)("h3",{id:"8-test-your-changes"},"8: Test your changes"),Object(i.b)("p",null,"Make sure relevant docker containers are rebuilt before testing the changes.\nIf this is a new field that has been added to an existing snapshot, then you can test by ingesting data that contains this new field. Here is an example of ingesting to ",Object(i.b)("inlineCode",{parentName:"p"},"/corpUsers")," endpoint, with the new field ",Object(i.b)("inlineCode",{parentName:"p"},"courses"),"."),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre"},'curl \'http://localhost:8080/corpUsers?action=ingest\' -X POST -H \'X-RestLi-Protocol-Version:2.0.0\' --data \'\n{\n  "snapshot": {\n    "aspects": [\n      {\n        "com.linkedin.identity.CorpUserEditableInfo": {\n          "courses": [\n            "Docker for Data Scientists",\n            "AI100: Introduction to Artificial Intelligence"\n          ],\n          "skills": [\n\n          ],\n          "pictureLink": "https://raw.githubusercontent.com/linkedin/datahub/master/datahub-web/packages/data-portal/public/assets/images/default_avatar.png",\n          "teams": [\n\n          ]\n        }\n      }\n    ],\n    "urn": "urn:li:corpuser:datahub"\n  }\n}\'\n')),Object(i.b)("p",null,"Once the ingestion is done, you can test your changes by issuing search queries. Here is an example query with response."),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-sh"},'curl "http://localhost:8080/corpUsers?q=search&input=ai100" -H \'X-RestLi-Protocol-Version: 2.0.0\' -s | jq\n\nResponse:\n{\n  "metadata": {\n    "urns": [\n      "urn:li:corpuser:datahub"\n    ],\n    "searchResultMetadatas": [\n\n    ]\n  },\n  "elements": [\n    {\n      "editableInfo": {\n        "skills": [\n\n        ],\n        "courses": [\n          "Docker for Data Scientists",\n          "AI100: Introduction to Artificial Intelligence"\n        ],\n        "pictureLink": "https://raw.githubusercontent.com/linkedin/datahub/master/datahub-web/packages/data-portal/public/assets/images/default_avatar.png",\n        "teams": [\n\n        ]\n      },\n      "username": "datahub",\n      "info": {\n        "active": true,\n        "fullName": "Data Hub",\n        "title": "CEO",\n        "displayName": "Data Hub",\n        "email": "datahub@linkedin.com"\n      }\n    }\n  ],\n  "paging": {\n    "count": 10,\n    "start": 0,\n    "total": 1,\n    "links": [\n\n    ]\n  }\n}\n')),Object(i.b)("h2",{id:"appendix-midtier-and-ui-changes"},"Appendix: MidTier and UI changes"),Object(i.b)("h3",{id:"1-check-if-facets-are-enabled-for-the-entity-optional"},"1: Check if facets are enabled for the entity (optional)"),Object(i.b)("p",null,"Inside the ",Object(i.b)("inlineCode",{parentName:"p"},"PersonEntity")," ",Object(i.b)("a",{parentName:"p",href:"https://github.com/linkedin/datahub/blob/master/datahub-web/@datahub/data-models/addon/entity/person/render-props.ts"},"render-props.ts")),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-json"},'{\n  "search": {\n    "showFacets": true\n  }\n}\n')),Object(i.b)("p",null,"make sure ",Object(i.b)("inlineCode",{parentName:"p"},"showFacets")," property is set to ",Object(i.b)("inlineCode",{parentName:"p"},"true"),"."),Object(i.b)("h3",{id:"2-add-fields-to-facets-in-midtier-if-desired-optional"},"2: Add fields to facets in MidTier if desired (optional)"),Object(i.b)("p",null,"In ",Object(i.b)("a",{parentName:"p",href:"https://github.com/linkedin/datahub/blob/master/datahub-frontend/app/controllers/api/v2/Search.java"},"Search.java")," add the desired fields here:"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-java"},'private static final Set<String> CORP_USER_FACET_FIELDS = ImmutableSet.of("courses");\n')),Object(i.b)("h3",{id:"3-add-field-in-the-person-entity"},"3: Add field in the Person entity"),Object(i.b)("p",null,"In ",Object(i.b)("a",{parentName:"p",href:"https://github.com/linkedin/datahub/blob/master/datahub-web/@datahub/data-models/addon/entity/person/person-entity.ts"},"person-entity.ts"),", add your new property"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-ts"},"@alias('entity.courses')\ncourses?: Array<string>;\n")),Object(i.b)("h3",{id:"4-add-fields-in-the-person-configuration-json"},"4: Add fields in the Person configuration json"),Object(i.b)("p",null,"Inside the ",Object(i.b)("inlineCode",{parentName:"p"},"PersonEntity")," ",Object(i.b)("a",{parentName:"p",href:"https://github.com/linkedin/datahub/blob/master/datahub-web/@datahub/data-models/addon/entity/person/render-props.ts"},"render-props.ts"),", add your new property:"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-json"},'{\n  "showInAutoCompletion": true,\n  "fieldName": "courses",\n  "showInResultsPreview": true,\n  "displayName": "Courses",\n  "showInFacets": true,\n  "desc": "Courses description of the field",\n  "example": "courses:value"\n}\n')))}l.isMDXComponent=!0}}]);